(()=>{"use strict";var e={28(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CONFIG=void 0,t.CONFIG={siteUrl:"https://julieandbryce.sharepoint.com",contactsListName:"CID Contacts",cidTagPattern:/\[CID-\d{4}-\d{4}\]/i,notifications:{noMatch:"CID_NO_MATCH",applied:"CID_APPLIED"}}},870(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getCidMatches=async function(e){const t=Array.from(new Set(e.map(e=>e.trim().toLowerCase()))).filter(Boolean);if(!t.length)return[];if(r()||!function(){try{return"undefined"!=typeof Office&&Office.context&&Office.context.mailbox&&void 0!==Office.context.mailbox.item}catch{return!1}}()){const e=r()?"localhost":"not in Outlook context";console.log(`üß™ MOCK MODE (${e}): Using mock data. Emails:`,t);const o=[];for(const e of t){const t=i[e];t&&o.push(t)}return console.log("Mock results:",o),o}return console.log("üöÄ PRODUCTION: Querying SharePoint. Emails:",t),async function(e){const t=function(e){const t=[];for(let o=0;o<e.length;o+=10)t.push(e.slice(o,o+10));return t}(e),o=[];for(const e of t){const t=await a(e);o.push(...t)}return o}(t)};const n=o(28),i={"jennifer@watervilleaudiology.com":{cid:"CID-2026-0002",opportunityName:"Waterville Audiology",matchedEmails:["jennifer@watervilleaudiology.com"]},"realty@julieandbryce.com":{cid:"CID-2026-TEST",opportunityName:"Test - Realty Account",matchedEmails:["realty@julieandbryce.com"]},"test@example.com":{cid:"CID-2026-0001",opportunityName:"Test Client",matchedEmails:["test@example.com"]}};function r(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname}function s(e){return e.replace(/'/g,"''")}async function a(e){var t,o,i,r,a;if(!n.CONFIG.siteUrl||n.CONFIG.siteUrl.startsWith("<"))throw new Error("CONFIG.siteUrl is not configured.");const c=e.map(e=>`(Client_x0020_Email_x0020_1 eq '${s(e)}' or Client_x0020_Email_x0020_2 eq '${s(e)}')`).join(" or "),l=`${n.CONFIG.siteUrl}/_api/web/lists/getbytitle('${encodeURIComponent(n.CONFIG.contactsListName)}')/items?$filter=${c}&$select=Title,Client_x0020_Email_x0020_1,Client_x0020_Email_x0020_2,KW_x0020_CID,KW_x0020_Opportunity_x0020_Name`;console.log("SharePoint query URL:",l);const u=await fetch(l,{method:"GET",headers:{Accept:"application/json;odata=nometadata"},credentials:"include"});if(!u.ok){const e=await u.text();throw console.error("SharePoint error:",u.status,e),new Error(`SharePoint query failed: ${u.status}`)}const d=await u.json();console.log("SharePoint response:",d);const m=[],f=new Map;for(const e of null!==(t=d.value)&&void 0!==t?t:[]){const t=null==e?void 0:e.KW_x0020_CID;if(!t)continue;const n=null!==(o=null==e?void 0:e.KW_x0020_Opportunity_x0020_Name)&&void 0!==o?o:void 0,s=null===(i=null==e?void 0:e.Client_x0020_Email_x0020_1)||void 0===i?void 0:i.toLowerCase(),c=null===(r=null==e?void 0:e.Client_x0020_Email_x0020_2)||void 0===r?void 0:r.toLowerCase(),l=null!==(a=f.get(t))&&void 0!==a?a:{cid:t,opportunityName:n,matchedEmails:[]};s&&!l.matchedEmails.includes(s)&&l.matchedEmails.push(s),c&&!l.matchedEmails.includes(c)&&l.matchedEmails.push(c),!l.opportunityName&&n&&(l.opportunityName=n),f.set(t,l)}return f.forEach(e=>m.push(e)),m}}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,o),r.exports}(()=>{const e=o(870),t=o(28);Office.onReady(()=>{console.log("Taskpane loaded");const o=document.getElementById("lookupBtn"),n=document.getElementById("applyBtn"),i=document.getElementById("emailInput"),r=document.getElementById("result");function s(e,t){r&&(r.textContent=e,r.className=t,r.style.display="block")}o&&i&&r&&o.addEventListener("click",async()=>{const t=i.value.trim();if(t){s("Looking up CID...","info");try{const o=await(0,e.getCidMatches)([t]);if(o.length>0){const e=o[0],t=e.opportunityName?` (${e.opportunityName})`:"";s(`‚úì Found: ${e.cid}${t}`,"success")}else s(`‚ùå No CID found for ${t}`,"error")}catch(e){s(`‚ùå Error: ${e.message}`,"error"),console.error("Lookup error:",e)}}else s("Please enter an email address","error")}),n&&r&&n.addEventListener("click",async()=>{s("Reading recipients...","info");try{const n=function(){try{return"undefined"!=typeof Office&&Office.context&&Office.context.mailbox&&void 0!==Office.context.mailbox.item}catch{return!1}}();let r=[];if(n)r=await new Promise((e,t)=>{const o=Office.context.mailbox.item;if(!o)return void t(new Error("No mail item available"));const n=[];let i=2;const r=()=>{i--,0===i&&e(n)};o.to.getAsync(e=>{if(e.status===Office.AsyncResultStatus.Succeeded)for(const t of e.value)t.emailAddress&&n.push(t.emailAddress.toLowerCase());r()}),o.cc.getAsync(e=>{if(e.status===Office.AsyncResultStatus.Succeeded)for(const t of e.value)t.emailAddress&&n.push(t.emailAddress.toLowerCase());r()})});else{const e=null==i?void 0:i.value.trim();e&&(r=[e.toLowerCase()],console.log("üß™ TEST MODE: Using email from input field:",e))}if(0===r.length)return void s(n?"‚ùå No recipients found. Add a To or CC recipient first.":"‚ùå Not in Outlook. Enter an email above to test.","error");s(`Looking up CID for: ${r.join(", ")}...`,"info");const a=await(0,e.getCidMatches)(r);if(0===a.length)return void s("‚ùå No CID found for recipients","error");const c=a[0];if(n){const e=await new Promise((e,t)=>{const o=Office.context.mailbox.item;o?o.subject.getAsync(o=>{o.status===Office.AsyncResultStatus.Succeeded?e(o.value||""):t(new Error("Failed to get subject"))}):t(new Error("No mail item available"))});if(t.CONFIG.cidTagPattern.test(e))return void s(`Subject already has a CID tag: ${e}`,"info");const n=`${e.trim()||"New Email"} - [${c.cid}]`;await(o=n,new Promise((e,t)=>{const n=Office.context.mailbox.item;n?n.subject.setAsync(o,o=>{o.status===Office.AsyncResultStatus.Succeeded?e():t(new Error("Failed to set subject"))}):t(new Error("No mail item available"))}));const i=c.opportunityName?` (${c.opportunityName})`:"";s(`‚úì Applied: [${c.cid}]${i}`,"success")}else{const e=c.opportunityName?` (${c.opportunityName})`:"";s(`üß™ TEST: Would apply [${c.cid}]${e} to subject`,"success")}}catch(e){s(`‚ùå Error: ${e.message}`,"error"),console.error("Apply error:",e)}var o})})})()})();
