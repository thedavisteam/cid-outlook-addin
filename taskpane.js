(()=>{"use strict";var e={28(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CONFIG=void 0,t.CONFIG={siteUrl:"https://julieandbryce.sharepoint.com",contactsListName:"CID Contacts",cidTagPattern:/\[CID-\d{4}-\d{4}\]/i,notifications:{noMatch:"CID_NO_MATCH",applied:"CID_APPLIED"}}},688(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.getAccessToken=async function(){const e=await async function(){var e;try{if("undefined"==typeof Office||!Office.context)return console.log("Not in Office context"),null;if("function"==typeof(null===(e=Office.auth)||void 0===e?void 0:e.getAccessToken))try{const e=await Office.auth.getAccessToken({allowSignInPrompt:!0,allowConsentPrompt:!0});return console.log("Got SSO token via Office.auth.getAccessToken"),o=e,e}catch(e){console.log("Office SSO failed:",e.code,e.message)}const t=Office.context;if(t.auth&&"function"==typeof t.auth.getAccessTokenAsync)return new Promise(e=>{t.auth.getAccessTokenAsync({forMSGraphAccess:!1},t=>{var n;t.status===Office.AsyncResultStatus.Succeeded?(console.log("Got SSO token via getAccessTokenAsync"),o=t.value,e(t.value)):(console.log("getAccessTokenAsync failed:",null===(n=t.error)||void 0===n?void 0:n.code),e(null))})})}catch(e){console.log("SSO not available:",e)}return null}();return e||null},t.clearToken=function(){o=null};let o=null},870(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getCidMatches=async function(e){const t=Array.from(new Set(e.map(e=>e.trim().toLowerCase()))).filter(Boolean);if(!t.length)return[];if(s()||!function(){try{return"undefined"!=typeof Office&&Office.context&&Office.context.mailbox&&void 0!==Office.context.mailbox.item}catch{return!1}}()){const e=s()?"localhost":"not in Outlook context";console.log(`üß™ MOCK MODE (${e}): Using mock data. Emails:`,t);const o=[];for(const e of t){const t=c[e];t&&o.push(t)}return console.log("Mock results:",o),o}return console.log("üöÄ PRODUCTION: Querying SharePoint. Emails:",t),async function(e){const t=function(e){const t=[];for(let o=0;o<e.length;o+=10)t.push(e.slice(o,o+10));return t}(e),o=[];for(const e of t){const t=await r(e);o.push(...t)}return o}(t)};const n=o(28),i=o(688),c={"jennifer@watervilleaudiology.com":{cid:"CID-2026-0002",opportunityName:"Waterville Audiology",matchedEmails:["jennifer@watervilleaudiology.com"]},"realty@julieandbryce.com":{cid:"CID-2026-TEST",opportunityName:"Test - Realty Account",matchedEmails:["realty@julieandbryce.com"]},"test@example.com":{cid:"CID-2026-0001",opportunityName:"Test Client",matchedEmails:["test@example.com"]}};function s(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname}function a(e){return e.replace(/'/g,"''")}async function r(e){var t,o,c,s,r;if(!n.CONFIG.siteUrl||n.CONFIG.siteUrl.startsWith("<"))throw new Error("CONFIG.siteUrl is not configured.");const l=await(0,i.getAccessToken)(),u=e.map(e=>`(Client_x0020_Email_x0020_1 eq '${a(e)}' or Client_x0020_Email_x0020_2 eq '${a(e)}')`).join(" or "),d=`${n.CONFIG.siteUrl}/_api/web/lists/getbytitle('${encodeURIComponent(n.CONFIG.contactsListName)}')/items?$filter=${u}&$select=Title,Client_x0020_Email_x0020_1,Client_x0020_Email_x0020_2,KW_x0020_CID,KW_x0020_Opportunity_x0020_Name`;console.log("SharePoint query URL:",d);const f={Accept:"application/json;odata=nometadata"};l&&(f.Authorization=`Bearer ${l}`);const m=await fetch(d,{method:"GET",headers:f,credentials:l?"omit":"include"});if(!m.ok){const e=await m.text();throw console.error("SharePoint error:",m.status,e),new Error(`SharePoint query failed: ${m.status}`)}const p=await m.json();console.log("SharePoint response:",p);const y=[],g=new Map;for(const e of null!==(t=p.value)&&void 0!==t?t:[]){const t=null==e?void 0:e.KW_x0020_CID;if(!t)continue;const n=null!==(o=null==e?void 0:e.KW_x0020_Opportunity_x0020_Name)&&void 0!==o?o:void 0,i=null===(c=null==e?void 0:e.Client_x0020_Email_x0020_1)||void 0===c?void 0:c.toLowerCase(),a=null===(s=null==e?void 0:e.Client_x0020_Email_x0020_2)||void 0===s?void 0:s.toLowerCase(),l=null!==(r=g.get(t))&&void 0!==r?r:{cid:t,opportunityName:n,matchedEmails:[]};i&&!l.matchedEmails.includes(i)&&l.matchedEmails.push(i),a&&!l.matchedEmails.includes(a)&&l.matchedEmails.push(a),!l.opportunityName&&n&&(l.opportunityName=n),g.set(t,l)}return g.forEach(e=>y.push(e)),y}}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var c=t[n]={exports:{}};return e[n](c,c.exports,o),c.exports}(()=>{const e=o(870),t=o(28);Office.onReady(o=>{console.log("[CID App v3.0.0] Taskpane loaded"),console.log(`[CID App] Host: ${o.host}, Platform: ${o.platform}`);const n=document.getElementById("debugInfo");if(n){const e=o.platform||"Unknown",t=o.host||"Unknown";n.innerHTML=`Platform: <b>${e}</b> | Host: <b>${t}</b> | Build: <b>__BUILD_TIME__</b>`}const i=document.getElementById("lookupBtn"),c=document.getElementById("applyBtn"),s=document.getElementById("emailInput"),a=document.getElementById("result");function r(e,t){a&&(a.textContent=e,a.className=t,a.style.display="block")}i&&s&&a&&i.addEventListener("click",async()=>{const t=s.value.trim();if(t){r("Looking up CID...","info");try{const o=await(0,e.getCidMatches)([t]);if(o.length>0){const e=o[0],t=e.opportunityName?` (${e.opportunityName})`:"";r(`‚úì Found: ${e.cid}${t}`,"success")}else r(`‚ùå No CID found for ${t}`,"error")}catch(e){r(`‚ùå Error: ${e.message}`,"error"),console.error("Lookup error:",e)}}else r("Please enter an email address","error")}),c&&a&&c.addEventListener("click",async()=>{r("Reading recipients...","info");try{const n=function(){try{return"undefined"!=typeof Office&&Office.context&&Office.context.mailbox&&void 0!==Office.context.mailbox.item}catch{return!1}}();let i=[];if(n)i=await new Promise((e,t)=>{const o=Office.context.mailbox.item;if(!o)return void t(new Error("No mail item available"));const n=[];let i=2;const c=()=>{i--,0===i&&e(n)};o.to.getAsync(e=>{if(e.status===Office.AsyncResultStatus.Succeeded)for(const t of e.value)t.emailAddress&&n.push(t.emailAddress.toLowerCase());c()}),o.cc.getAsync(e=>{if(e.status===Office.AsyncResultStatus.Succeeded)for(const t of e.value)t.emailAddress&&n.push(t.emailAddress.toLowerCase());c()})});else{const e=null==s?void 0:s.value.trim();e&&(i=[e.toLowerCase()],console.log("üß™ TEST MODE: Using email from input field:",e))}if(0===i.length)return void r(n?"‚ùå No recipients found. Add a To or CC recipient first.":"‚ùå Not in Outlook. Enter an email above to test.","error");r(`Looking up CID for: ${i.join(", ")}...`,"info");const c=await(0,e.getCidMatches)(i);if(0===c.length)return void r("‚ùå No CID found for recipients","error");const a=c[0];if(n){const e=await new Promise((e,t)=>{const o=Office.context.mailbox.item;o?o.subject.getAsync(o=>{o.status===Office.AsyncResultStatus.Succeeded?e(o.value||""):t(new Error("Failed to get subject"))}):t(new Error("No mail item available"))});if(t.CONFIG.cidTagPattern.test(e))return void r(`Subject already has a CID tag: ${e}`,"info");const n=`${e.trim()||"New Email"} - [${a.cid}]`;await(o=n,new Promise((e,t)=>{const n=Office.context.mailbox.item;n?n.subject.setAsync(o,o=>{o.status===Office.AsyncResultStatus.Succeeded?e():t(new Error("Failed to set subject"))}):t(new Error("No mail item available"))}));const i=a.opportunityName?` (${a.opportunityName})`:"";r(`‚úì Applied: [${a.cid}]${i}`,"success")}else{const e=a.opportunityName?` (${a.opportunityName})`:"";r(`üß™ TEST: Would apply [${a.cid}]${e} to subject`,"success")}}catch(e){r(`‚ùå Error: ${e.message}`,"error"),console.error("Apply error:",e)}var o})})})()})();