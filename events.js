(()=>{"use strict";var e={28(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CONFIG=void 0,t.CONFIG={siteUrl:"https://julieandbryce.sharepoint.com",contactsListName:"CID Contacts",cidTagPattern:/\[CID-\d{4}-\d{4}\]/i,notifications:{noMatch:"CID_NO_MATCH",applied:"CID_APPLIED"}}},673(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.extractExistingCid=i,t.applyCidToSubject=function(e,t){return i(e)?e:e&&e.trim()?`${e.trim()} - [${t}]`:`[${t}]`},t.getAllRecipients=async function(e){const t=[...await c(t=>e.to.getAsync({asyncContext:null},t)),...await c(t=>e.cc.getAsync({asyncContext:null},t)),...e.bcc?await c(t=>e.bcc.getAsync({asyncContext:null},t)):[]].map(e=>(null==e?void 0:e.emailAddress)||(null==e?void 0:e.displayName)).filter(Boolean).map(e=>e.trim().toLowerCase());return Array.from(new Set(t))},t.getSubject=async function(e){return c(t=>e.subject.getAsync(t))},t.setSubject=async function(e,t){return c(o=>e.subject.setAsync(t,o))},t.showInfo=async function(e,t){return c(o=>e.notificationMessages.replaceAsync(n.CONFIG.notifications.noMatch,{type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:t,icon:"Icon.16x16",persistent:!1},o))};const n=o(28);function i(e){const t=e.match(n.CONFIG.cidTagPattern);return t?t[0]:void 0}function c(e){return new Promise((t,o)=>{e(e=>{e.status===Office.AsyncResultStatus.Succeeded?t(e.value):o(e.error)})})}},688(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.getAccessToken=async function(){const e=await async function(){var e;try{if("undefined"==typeof Office||!Office.context)return console.log("Not in Office context"),null;if("function"==typeof(null===(e=Office.auth)||void 0===e?void 0:e.getAccessToken))try{const e=await Office.auth.getAccessToken({allowSignInPrompt:!0,allowConsentPrompt:!0});return console.log("Got SSO token via Office.auth.getAccessToken"),o=e,e}catch(e){console.log("Office SSO failed:",e.code,e.message)}const t=Office.context;if(t.auth&&"function"==typeof t.auth.getAccessTokenAsync)return new Promise(e=>{t.auth.getAccessTokenAsync({forMSGraphAccess:!1},t=>{var n;t.status===Office.AsyncResultStatus.Succeeded?(console.log("Got SSO token via getAccessTokenAsync"),o=t.value,e(t.value)):(console.log("getAccessTokenAsync failed:",null===(n=t.error)||void 0===n?void 0:n.code),e(null))})})}catch(e){console.log("SSO not available:",e)}return null}();return e||null},t.clearToken=function(){o=null};let o=null},870(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getCidMatches=async function(e){const t=Array.from(new Set(e.map(e=>e.trim().toLowerCase()))).filter(Boolean);if(!t.length)return[];if(a()||!function(){try{return"undefined"!=typeof Office&&Office.context&&Office.context.mailbox&&void 0!==Office.context.mailbox.item}catch{return!1}}()){const e=a()?"localhost":"not in Outlook context";console.log(`ðŸ§ª MOCK MODE (${e}): Using mock data. Emails:`,t);const o=[];for(const e of t){const t=c[e];t&&o.push(t)}return console.log("Mock results:",o),o}return console.log("ðŸš€ PRODUCTION: Querying SharePoint. Emails:",t),async function(e){const t=function(e){const t=[];for(let o=0;o<e.length;o+=10)t.push(e.slice(o,o+10));return t}(e),o=[];for(const e of t){const t=await r(e);o.push(...t)}return o}(t)};const n=o(28),i=o(688),c={"realty@julieandbryce.com":{cid:"CID-2026-TEST",opportunityName:"Test - Realty Account",matchedEmails:["realty@julieandbryce.com"]},"realty@watervilleaudiology.com":{cid:"CID-2026-0003",opportunityName:"Waterville Audiology - Realty",matchedEmails:["realty@watervilleaudiology.com"]},"jennifer@watervilleaudiology.com":{cid:"CID-2026-0002",opportunityName:"Waterville Audiology",matchedEmails:["jennifer@watervilleaudiology.com"]},"test@example.com":{cid:"CID-2026-0001",opportunityName:"Test Client",matchedEmails:["test@example.com"]}};function a(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname}function s(e){return e.replace(/'/g,"''")}async function r(e){var t,o,c,a,r;if(!n.CONFIG.siteUrl||n.CONFIG.siteUrl.startsWith("<"))throw new Error("CONFIG.siteUrl is not configured.");const l=await(0,i.getAccessToken)(),u=e.map(e=>`(Client_x0020_Email_x0020_1 eq '${s(e)}' or Client_x0020_Email_x0020_2 eq '${s(e)}')`).join(" or "),f=`${n.CONFIG.siteUrl}/_api/web/lists/getbytitle('${encodeURIComponent(n.CONFIG.contactsListName)}')/items?$filter=${u}&$select=Title,Client_x0020_Email_x0020_1,Client_x0020_Email_x0020_2,KW_x0020_CID,KW_x0020_Opportunity_x0020_Name`;console.log("SharePoint query URL:",f);const d={Accept:"application/json;odata=nometadata"};l&&(d.Authorization=`Bearer ${l}`);const m=await fetch(f,{method:"GET",headers:d,credentials:l?"omit":"include"});if(!m.ok){const e=await m.text();if(console.error("SharePoint error:",m.status,e),401===m.status||403===m.status)throw new Error("Authentication failed. Please ensure you're logged into Microsoft 365 with access to the SharePoint site.");throw new Error(`SharePoint query failed: ${m.status} - ${e.substring(0,100)}`)}const p=await m.json();console.log("SharePoint response:",p);const y=[],h=new Map;for(const e of null!==(t=p.value)&&void 0!==t?t:[]){const t=null==e?void 0:e.KW_x0020_CID;if(!t)continue;const n=null!==(o=null==e?void 0:e.KW_x0020_Opportunity_x0020_Name)&&void 0!==o?o:void 0,i=null===(c=null==e?void 0:e.Client_x0020_Email_x0020_1)||void 0===c?void 0:c.toLowerCase(),s=null===(a=null==e?void 0:e.Client_x0020_Email_x0020_2)||void 0===a?void 0:a.toLowerCase(),l=null!==(r=h.get(t))&&void 0!==r?r:{cid:t,opportunityName:n,matchedEmails:[]};i&&!l.matchedEmails.includes(i)&&l.matchedEmails.push(i),s&&!l.matchedEmails.includes(s)&&l.matchedEmails.push(s),!l.opportunityName&&n&&(l.opportunityName=n),h.set(t,l)}return h.forEach(e=>y.push(e)),y}}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var c=t[n]={exports:{}};return e[n](c,c.exports,o),c.exports}(()=>{const e=o(673),t=o(870);async function n(){const o=Office.context.mailbox.item,n=await(0,e.getAllRecipients)(o);if(!n.length)return{};const i=await(0,t.getCidMatches)(n);if(!i.length)return await(0,e.showInfo)(o,"No CID found for current recipients. Consider adding this contact to the CID Register if appropriate."),{};const c=Array.from(new Set(i.map(e=>e.cid)));if(c.length>1)return await(0,e.showInfo)(o,`Multiple CIDs matched: ${c.join(", ")}. Choose the correct CID before sending.`),{multipleCids:c};const a=c[0],s=await(0,e.getSubject)(o),r=(0,e.applyCidToSubject)(s,a);return r!==s&&await(0,e.setSubject)(o,r),await(0,e.showInfo)(o,`CID applied: [${a}]`),{appliedCid:a}}Office.actions.associate("onNewMessageCompose",async function(e){try{await n()}catch(e){console.error("onNewMessageCompose error",e)}finally{e.completed()}}),Office.actions.associate("onRecipientsChanged",async function(e){try{await n()}catch(e){console.error("onRecipientsChanged error",e)}finally{e.completed()}}),Office.actions.associate("onMessageSend",async function(e){try{const t=await n();if(t.multipleCids&&t.multipleCids.length>1){const o={allowEvent:!1,errorMessage:`Multiple CIDs matched: ${t.multipleCids.join(", ")}. Remove ambiguous recipients or select one CID.`};return void e.completed(o)}e.completed({allowEvent:!0})}catch(t){console.error("onMessageSend error",t);const o={allowEvent:!1,errorMessage:"CID validation failed. Please try again or check network/auth settings."};e.completed(o)}})})()})();