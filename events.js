(()=>{"use strict";var e={28(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.CONFIG=void 0,t.CONFIG={siteUrl:"https://julieandbryce.sharepoint.com",contactsListName:"CID Contacts",cidTagPattern:/\[CID-\d{4}-\d{4}\]/i,notifications:{noMatch:"CID_NO_MATCH",applied:"CID_APPLIED"}}},673(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.extractExistingCid=i,t.applyCidToSubject=function(e,t){return i(e)?e:e&&e.trim()?`${e.trim()} - [${t}]`:`[${t}]`},t.getAllRecipients=async function(e){const t=[...await a(t=>e.to.getAsync({asyncContext:null},t)),...await a(t=>e.cc.getAsync({asyncContext:null},t)),...e.bcc?await a(t=>e.bcc.getAsync({asyncContext:null},t)):[]].map(e=>(null==e?void 0:e.emailAddress)||(null==e?void 0:e.displayName)).filter(Boolean).map(e=>e.trim().toLowerCase());return Array.from(new Set(t))},t.getSubject=async function(e){return a(t=>e.subject.getAsync(t))},t.setSubject=async function(e,t){return a(o=>e.subject.setAsync(t,o))},t.showInfo=async function(e,t){return a(o=>e.notificationMessages.replaceAsync(n.CONFIG.notifications.noMatch,{type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:t,icon:"Icon.16x16",persistent:!1},o))};const n=o(28);function i(e){const t=e.match(n.CONFIG.cidTagPattern);return t?t[0]:void 0}function a(e){return new Promise((t,o)=>{e(e=>{e.status===Office.AsyncResultStatus.Succeeded?t(e.value):o(e.error)})})}},870(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getCidMatches=async function(e){const t=Array.from(new Set(e.map(e=>e.trim().toLowerCase()))).filter(Boolean);if(!t.length)return[];if("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname){console.log("ðŸ§ª LOCAL DEV: Using mock data. Emails:",t);const e=[];for(const o of t){const t=i[o];t&&e.push(t)}return console.log("Mock results:",e),e}return console.log("ðŸš€ PRODUCTION: Querying SharePoint. Emails:",t),async function(e){const t=function(e){const t=[];for(let o=0;o<e.length;o+=10)t.push(e.slice(o,o+10));return t}(e),o=[];for(const e of t){const t=await s(e);o.push(...t)}return o}(t)};const n=o(28),i={"jennifer@watervilleaudiology.com":{cid:"CID-2026-0002",opportunityName:"Waterville Audiology",matchedEmails:["jennifer@watervilleaudiology.com"]},"realty@julieandbryce.com":{cid:"CID-2026-TEST",opportunityName:"Test - Realty Account",matchedEmails:["realty@julieandbryce.com"]},"test@example.com":{cid:"CID-2026-0001",opportunityName:"Test Client",matchedEmails:["test@example.com"]}};function a(e){return e.replace(/'/g,"''")}async function s(e){var t,o,i,s,c;if(!n.CONFIG.siteUrl||n.CONFIG.siteUrl.startsWith("<"))throw new Error("CONFIG.siteUrl is not configured.");const r=e.map(e=>`(Email eq '${a(e)}' or Client_x0020_Email_x0020_2 eq '${a(e)}')`).join(" or "),l=`${n.CONFIG.siteUrl}/_api/web/lists/getbytitle('${encodeURIComponent(n.CONFIG.contactsListName)}')/items?$filter=${r}&$select=Title,Email,Client_x0020_Email_x0020_2,KW_x0020_CID,KW_x0020_Opportunity_x0020_Name`;console.log("SharePoint query URL:",l);const u=await fetch(l,{method:"GET",headers:{Accept:"application/json;odata=nometadata"},credentials:"include"});if(!u.ok){const e=await u.text();throw console.error("SharePoint error:",u.status,e),new Error(`SharePoint query failed: ${u.status}`)}const d=await u.json();console.log("SharePoint response:",d);const m=[],p=new Map;for(const e of null!==(t=d.value)&&void 0!==t?t:[]){const t=null==e?void 0:e.KW_x0020_CID;if(!t)continue;const n=null!==(o=null==e?void 0:e.KW_x0020_Opportunity_x0020_Name)&&void 0!==o?o:void 0,a=null===(i=null==e?void 0:e.Email)||void 0===i?void 0:i.toLowerCase(),r=null===(s=null==e?void 0:e.Client_x0020_Email_x0020_2)||void 0===s?void 0:s.toLowerCase(),l=null!==(c=p.get(t))&&void 0!==c?c:{cid:t,opportunityName:n,matchedEmails:[]};a&&!l.matchedEmails.includes(a)&&l.matchedEmails.push(a),r&&!l.matchedEmails.includes(r)&&l.matchedEmails.push(r),!l.opportunityName&&n&&(l.opportunityName=n),p.set(t,l)}return p.forEach(e=>m.push(e)),m}}},t={};function o(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,o),a.exports}(()=>{const e=o(673),t=o(870);async function n(){const o=Office.context.mailbox.item,n=await(0,e.getAllRecipients)(o);if(!n.length)return{};const i=await(0,t.getCidMatches)(n);if(!i.length)return await(0,e.showInfo)(o,"No CID found for current recipients. Consider adding this contact to the CID Register if appropriate."),{};const a=Array.from(new Set(i.map(e=>e.cid)));if(a.length>1)return await(0,e.showInfo)(o,`Multiple CIDs matched: ${a.join(", ")}. Choose the correct CID before sending.`),{multipleCids:a};const s=a[0],c=await(0,e.getSubject)(o),r=(0,e.applyCidToSubject)(c,s);return r!==c&&await(0,e.setSubject)(o,r),await(0,e.showInfo)(o,`CID applied: [${s}]`),{appliedCid:s}}Office.actions.associate("onNewMessageCompose",async function(e){try{await n()}catch(e){console.error("onNewMessageCompose error",e)}finally{e.completed()}}),Office.actions.associate("onRecipientsChanged",async function(e){try{await n()}catch(e){console.error("onRecipientsChanged error",e)}finally{e.completed()}}),Office.actions.associate("onMessageSend",async function(e){try{const t=await n();if(t.multipleCids&&t.multipleCids.length>1){const o={allowEvent:!1,errorMessage:`Multiple CIDs matched: ${t.multipleCids.join(", ")}. Remove ambiguous recipients or select one CID.`};return void e.completed(o)}e.completed({allowEvent:!0})}catch(t){console.error("onMessageSend error",t);const o={allowEvent:!1,errorMessage:"CID validation failed. Please try again or check network/auth settings."};e.completed(o)}})})()})();